name: publish-ghcr

on:
  push:
    branches: [ main ]
    tags: [ 'v*', '*[0-9].[0-9].[0-9]*', 'release-*', '*.*.*' ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/relay-server

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout relay-server
        uses: actions/checkout@v4

      - name: Checkout relay-clients
        uses: actions/checkout@v4
        with:
          repository: clevertree/relay-clients
          path: relay-clients

      - name: Checkout relay-template
        uses: actions/checkout@v4
        with:
          repository: clevertree/relay-template
          path: relay-template

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build web client
        run: |
          echo "Listing all package.json files:"
          find relay-clients -maxdepth 3 -name "package.json"
          
          # Install dependencies in all packages found (monorepo support)
          find relay-clients -maxdepth 3 -name "package.json" | while read f; do
            dir=$(dirname "$f")
            echo "--- Installing in $dir ---"
            cd "$dir"
            if [ -f "pnpm-lock.yaml" ]; then
              npm install -g pnpm
              pnpm install --no-frozen-lockfile
            else
              npm install --no-fund --no-audit
            fi
            cd - > /dev/null
          done

          if [ -d "relay-clients/web" ]; then
            WEB_PATH="relay-clients/web"
          elif [ -d "relay-clients/packages/web" ]; then
            WEB_PATH="relay-clients/packages/web"
          else
            echo "Could not find web client directory in relay-clients repository"
            exit 1
          fi

          # Fix template symlink/directory
          mkdir -p $WEB_PATH/public
          rm -rf $WEB_PATH/public/template
          if [ -d "relay-template" ]; then
            ln -s ../../../relay-template $WEB_PATH/public/template
            echo "Linked relay-template to $WEB_PATH/public/template"
          else
            mkdir -p $WEB_PATH/public/template
            echo "Created empty $WEB_PATH/public/template"
          fi

          echo "Listing files in $WEB_PATH/src/wasm:"
          ls -R $WEB_PATH/src/wasm || echo "Not found"
          
          echo "Checking imports of themed_styler_bg.wasm:"
          grep -r "themed_styler_bg.wasm" $WEB_PATH/src || echo "None found"

          echo "Checking contents of $WEB_PATH/src/wasm/themed_styler.js (first 20 lines):"
          head -n 20 $WEB_PATH/src/wasm/themed_styler.js || echo "Not found"
          cd $WEB_PATH
          
          echo "Current directory: $(pwd)"
          
          # Hack: Fix vite.config.ts for CI
          # 1. Inject missing plugins
          # 2. Add assetsInclude for wasm
          # 3. Add explicit external for 'wbg'
          
          npm install --no-fund --no-audit @rollup/plugin-yaml vite-plugin-top-level-await vite-plugin-wasm
          
          # Inject imports at the top if they don't exist
          grep -q "import yaml" vite.config.ts || sed -i "1i import yaml from '@rollup/plugin-yaml'" vite.config.ts
          grep -q "import topLevelAwait" vite.config.ts || sed -i "1i import topLevelAwait from 'vite-plugin-top-level-await'" vite.config.ts
          grep -q "import wasm" vite.config.ts || sed -i "1i import wasm from 'vite-plugin-wasm'" vite.config.ts
          
          # Inject plugins into the plugins array (only if not already there)
          grep -q "wasm()," vite.config.ts || sed -i "s/plugins: \[/plugins: \[wasm(), /" vite.config.ts
          grep -q "yaml()," vite.config.ts || sed -i "s/plugins: \[/plugins: \[yaml(), /" vite.config.ts
          grep -q "topLevelAwait()," vite.config.ts || sed -i "s/plugins: \[/plugins: \[topLevelAwait(), /" vite.config.ts
          
          # Add assetsInclude if it doesn't exist
          grep -q "assetsInclude" vite.config.ts || sed -i "/export default defineConfig({/a \  assetsInclude: ['**/*.wasm']," vite.config.ts
          
          # Inject rollupOptions into ALL build blocks (to ensure it's not overridden)
          sed -i "/build: {/a \    rollupOptions: { external: ['wbg'] }," vite.config.ts
          
          echo "Patched vite.config.ts:"
          cat vite.config.ts

          npm run build
          
          mkdir -p ../../dist-web
          cp -r dist/* ../../dist-web/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=sha-,format=short
            type=ref,event=branch
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
